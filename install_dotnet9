#!/bin/bash
# install_dotnet9.sh
# Instala .NET 9 Runtime e configura migração automática de .NET 8 para .NET 9

set -e

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Funções de log
log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Função para verificar se .NET está instalado
check_dotnet_installed() {
    if command -v dotnet &> /dev/null; then
        log_info ".NET encontrado no PATH"
        dotnet --version
        return 0
    elif [ -f ~/.dotnet/dotnet ]; then
        log_info ".NET encontrado em ~/.dotnet"
        ~/.dotnet/dotnet --version
        return 0
    else
        log_warn ".NET não encontrado"
        return 1
    fi
}

# Função para verificar versões específicas
check_dotnet_versions() {
    log_info "=== Verificando versões instaladas ==="

    # Verificar runtimes
    if command -v dotnet &> /dev/null; then
        log_info "Runtimes instalados:"
        dotnet --list-runtimes
        echo ""

        # Verificar se .NET 8 está instalado
        if dotnet --list-runtimes | grep -q "Microsoft.NETCore.App 8\."; then
            log_warn ".NET 8 Runtime encontrado"
            DOTNET8_INSTALLED=true
        else
            DOTNET8_INSTALLED=false
        fi

        # Verificar se .NET 9 já está instalado
        if dotnet --list-runtimes | grep -q "Microsoft.NETCore.App 9\."; then
            log_info "✅ .NET 9 já está instalado"
            DOTNET9_INSTALLED=true
        else
            log_warn ".NET 9 não encontrado"
            DOTNET9_INSTALLED=false
        fi
    else
        DOTNET8_INSTALLED=false
        DOTNET9_INSTALLED=false
    fi
}

# Função para instalar .NET 9 via script oficial da Microsoft
install_dotnet9() {
    log_info "=== Instalando .NET 9 Runtime ==="

    # Criar diretório de instalação
    mkdir -p ~/.dotnet

    # Baixar script de instalação
    log_info "Baixando script de instalação..."
    curl -sSL https://dot.net/v1/dotnet-install.sh -o /tmp/dotnet-install.sh
    chmod +x /tmp/dotnet-install.sh

    # Instalar .NET 9 Runtime
    log_info "Instalando .NET 9 Runtime..."
    /tmp/dotnet-install.sh \
        --channel 9.0 \
        --runtime dotnet \
        --install-dir ~/.dotnet \
        --no-path

    # Instalar ASP.NET Core Runtime (opcional, mas recomendado)
    log_info "Instalando ASP.NET Core Runtime 9..."
    /tmp/dotnet-install.sh \
        --channel 9.0 \
        --runtime aspnetcore \
        --install-dir ~/.dotnet \
        --no-path

    # Limpar
    rm -f /tmp/dotnet-install.sh

    log_info "✅ .NET 9 Runtime instalado"
}

# Função para configurar PATH
setup_path() {
    log_info "=== Configurando PATH ==="

    # Adicionar ao .bashrc se não existir
    if ! grep -q "export DOTNET_ROOT=" ~/.bashrc; then
        echo 'export DOTNET_ROOT="$HOME/.dotnet"' >> ~/.bashrc
        log_info "Adicionado DOTNET_ROOT ao .bashrc"
    fi

    if ! grep -q 'export PATH="$HOME/.dotnet:$PATH"' ~/.bashrc; then
        echo 'export PATH="$HOME/.dotnet:$PATH"' >> ~/.bashrc
        log_info "Adicionado .dotnet ao PATH no .bashrc"
    fi

    # Configurar para a sessão atual
    export DOTNET_ROOT="$HOME/.dotnet"
    export PATH="$HOME/.dotnet:$PATH"

    # Verificar instalação
    log_info "Verificando instalação..."
    ~/.dotnet/dotnet --info
}

# Função para migrar projetos .NET 8 para .NET 9
migrate_projects() {
    log_info "=== Migrando projetos .NET 8 para .NET 9 ==="

    # Lista de arquivos de projeto para procurar
    local project_files=$(find ~ -name "*.csproj" -o -name "*.fsproj" -o -name "*.vbproj" 2>/dev/null | head -20)

    if [ -z "$project_files" ]; then
        log_info "Nenhum arquivo de projeto encontrado para migração"
        return
    fi

    log_info "Procurando projetos .NET 8..."

    for project_file in $project_files; do
        # Verificar se é .NET 8
        if grep -q '<TargetFramework>net8.0</TargetFramework>' "$project_file" || \
           grep -q 'net8.0' "$project_file"; then

            log_info "Migrando: $project_file"

            # Backup do arquivo original
            cp "$project_file" "${project_file}.backup"

            # Substituir net8.0 por net9.0
            sed -i 's/net8\.0/net9.0/g' "$project_file"
            sed -i 's/8\.0\./9.0./g' "$project_file"

            # Atualizar pacotes comuns do .NET 8 para .NET 9
            sed -i 's/Microsoft\.NETCore\.App" Version="8\./Microsoft.NETCore.App" Version="9./g' "$project_file"
            sed -i 's/Microsoft\.AspNetCore\.App" Version="8\./Microsoft.AspNetCore.App" Version="9./g' "$project_file"
            sed -i 's/Microsoft\.AspNetCore\.Mvc" Version="8\./Microsoft.AspNetCore.Mvc" Version="9./g' "$project_file"

            log_info "✅ $project_file migrado para .NET 9"

            # Tentar restaurar pacotes (opcional)
            local project_dir=$(dirname "$project_file")
            if cd "$project_dir" 2>/dev/null; then
                if ~/.dotnet/dotnet restore 2>/dev/null; then
                    log_info "   Pacotes restaurados com sucesso"
                else
                    log_warn "   Não foi possível restaurar pacotes automaticamente"
                fi
                cd - >/dev/null
            fi
        fi
    done
}

# Função para criar global.json para forçar .NET 9
setup_global_json() {
    log_info "=== Configurando global.json ==="

    # Criar ou atualizar global.json na home
    cat > ~/global.json << 'EOF'
{
  "sdk": {
    "version": "9.0.100",
    "rollForward": "latestFeature",
    "allowPrerelease": false
  },
  "msbuild-sdks": {
    "Microsoft.Build.NoTargets": "3.7.0"
  }
}
EOF

    log_info "global.json criado para usar .NET 9 por padrão"
}

# Função para configurar aliases úteis
setup_aliases() {
    log_info "=== Configurando aliases ==="

    # Adicionar aliases ao .bashrc
    if ! grep -q "# .NET Aliases" ~/.bashrc; then
        cat >> ~/.bashrc << 'EOF'

# .NET Aliases
alias dn='dotnet new'
alias dr='dotnet run'
alias db='dotnet build'
alias dt='dotnet test'
alias dp='dotnet publish'
alias ds='dotnet sln'
alias dng='dotnet --info'
alias dnl='dotnet --list-runtimes'
alias dn9='dotnet --version | grep -q "^9" && echo "Using .NET 9" || echo "Not using .NET 9"'
EOF
        log_info "Aliases adicionados ao .bashrc"
    fi
}

# Função para verificar compatibilidade
check_compatibility() {
    log_info "=== Verificando compatibilidade ==="

    # Criar projeto de teste
    mkdir -p /tmp/dotnet-test
    cd /tmp/dotnet-test

    log_info "Criando projeto de teste..."
    ~/.dotnet/dotnet new console -n TestApp9 --force 2>/dev/null

    # Atualizar para .NET 9
    sed -i 's/net8.0/net9.0/g' TestApp9.csproj

    # Tentar build
    log_info "Testando build com .NET 9..."
    if ~/.dotnet/dotnet build; then
        log_info "✅ Projeto de teste compilado com sucesso com .NET 9"

        # Testar execução
        if ~/.dotnet/dotnet run; then
            log_info "✅ Projeto executado com sucesso com .NET 9"
        fi
    else
        log_error "❌ Falha ao compilar projeto de teste"
    fi

    cd - >/dev/null
    rm -rf /tmp/dotnet-test
}

# Função principal
main() {
    log_info "=== Script de Instalação e Migração .NET 9 ==="
    log_info "Data: $(date)"

    # 1. Verificar instalação atual
    check_dotnet_installed || true
    check_dotnet_versions

    # 2. Instalar .NET 9 se necessário
    if [ "$DOTNET9_INSTALLED" = false ]; then
        install_dotnet9
        setup_path
    else
        log_info "Pulando instalação - .NET 9 já está instalado"
    fi

    # 3. Configurar ambiente
    setup_global_json
    setup_aliases

    # 4. Migrar projetos se .NET 8 estiver instalado
    if [ "$DOTNET8_INSTALLED" = true ]; then
        read -p "Deseja migrar projetos .NET 8 para .NET 9? (s/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Ss]$ ]]; then
            migrate_projects
        else
            log_info "Migração de projetos ignorada"
        fi
    fi

    # 5. Verificar compatibilidade
    check_compatibility

    # 6. Instruções finais
    log_info "=== Instalação concluída ==="
    log_info "Para usar o .NET 9 nesta sessão, execute:"
    echo "    source ~/.bashrc"
    log_info "Ou abra um novo terminal"
    log_info ""
    log_info "Comandos disponíveis:"
    log_info "  dotnet --info          - Ver informações do .NET"
    log_info "  dotnet --list-runtimes - Listar runtimes instalados"
    log_info "  dn9                    - Verificar se está usando .NET 9"
    log_info ""
    log_info "Para migrar projetos manualmente:"
    log_info "  1. Atualize TargetFramework para net9.0 no .csproj"
    log_info "  2. Execute: dotnet restore"
    log_info "  3. Execute: dotnet build"
}

# Executar função principal
main "$@"
